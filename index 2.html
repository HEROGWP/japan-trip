<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>勤益碩士班畢業旅行 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F5F5F0;
            -webkit-tap-highlight-color: transparent;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.03); }

        .tab-active { color: #2D3748; border-bottom: 3px solid #63B3ED; font-weight: 700; }
        .tab-inactive { color: #A0AEC0; }
        
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        .weather-tag {
            display: inline-flex;
            align-items: center;
            font-size: 0.7rem;
            color: #718096;
            background-color: #F7FAFC;
            padding: 2px 8px;
            border-radius: 9999px;
            margin-right: 4px;
            border: 1px solid #EDF2F7;
        }
        .weather-tag i { margin-right: 4px; }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col max-w-md mx-auto bg-white shadow-2xl relative overflow-hidden">

    <header class="bg-white pt-10 pb-4 px-6 sticky top-0 z-20 border-b border-gray-100">
        <div class="flex justify-between items-end">
            <div>
                <p class="text-xs font-bold tracking-widest text-blue-400 uppercase mb-1">JAPAN TRIP 2026</p>
                <h1 class="text-2xl font-bold text-gray-800">東北藏王樹冰雪怪之旅</h1>
                <p class="text-sm text-gray-400 mt-1"><i class="far fa-calendar-alt mr-1"></i> 01/23 - 01/28 (6天)</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-400 mb-1">東京即時</div>
                <div id="header-weather" class="text-3xl font-light text-gray-600">--<span class="text-sm">°C</span></div>
            </div>
        </div>
    </header>

    <nav class="flex justify-around bg-white border-b border-gray-100 z-10 sticky top-[110px]">
        <button onclick="switchTab('itinerary')" id="btn-itinerary" class="flex-1 py-4 text-sm tab-active transition-all">每日行程</button>
        <button onclick="switchTab('tools')" id="btn-tools" class="flex-1 py-4 text-sm tab-inactive transition-all">旅人工具箱</button>
    </nav>

    <main class="flex-1 overflow-y-auto no-scrollbar bg-[#F9FAFB] p-4 pb-24" id="main-content">
        
        <div id="view-itinerary" class="space-y-6">
            
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                    <div>
                        <h2 class="font-bold text-lg">DAY 1 <span class="text-sm font-normal text-gray-400 ml-2">01/23 (五)</span></h2>
                        <div id="weather-stats-0" class="mt-2 flex flex-wrap gap-y-2">
                             <span class="text-xs text-gray-400 loading-pulse">載入中...</span>
                        </div>
                    </div>
                    <div id="weather-icon-0" class="text-2xl text-gray-300"></div>
                </div>
                
                <div class="space-y-4 relative pl-4 border-l-2 border-gray-100 pb-2 pt-2">
                    <p class="text-xs text-gray-400 absolute -top-2 left-2 bg-[#F9FAFB] px-1">地點: 成田/東京</p>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-blue-400 rounded-full border-2 border-white"></div>
                        <p class="text-xs text-gray-400 mb-1">12:50 集合</p>
                        <h3 class="font-bold text-gray-800">桃園機場 第二航廈</h3>
                        <p class="text-sm text-gray-500 mt-1">長榮航空團體櫃檯集合</p>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div>
                        <p class="text-xs text-gray-400 mb-1">15:20 - 19:20</p>
                        <h3 class="font-bold text-gray-800"><i class="fas fa-plane text-blue-400 mr-1"></i> 飛往東京 (BR196)</h3>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-indigo-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800"><i class="fas fa-bed text-indigo-400 mr-1"></i> 入住: 成田日航飯店</h3>
                    </div>
                </div>
                <div class="mt-2 bg-slate-50 rounded-lg p-3 text-sm text-gray-600 space-y-2">
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">午</span> <span class="flex-1">自理 (機上可能有用餐時間)</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">晚</span> <span class="flex-1">機上套餐</span></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                    <div>
                        <h2 class="font-bold text-lg">DAY 2 <span class="text-sm font-normal text-gray-400 ml-2">01/24 (六)</span></h2>
                        <div id="weather-stats-1" class="mt-2 flex flex-wrap gap-y-2">
                             <span class="text-xs text-gray-400 loading-pulse">載入中...</span>
                        </div>
                    </div>
                    <div id="weather-icon-1" class="text-2xl text-gray-300"></div>
                </div>

                <div class="space-y-4 relative pl-4 border-l-2 border-gray-100 pb-2 pt-2">
                    <p class="text-xs text-gray-400 absolute -top-2 left-2 bg-[#F9FAFB] px-1">地點: 福島會津</p>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">水戶偕樂園</h3>
                        <p class="text-sm text-gray-500">日本三大名園之一，賞梅聖地。</p>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">會津若松城 (鶴城)</h3>
                        <p class="text-sm text-gray-500">百選名城，如白鶴飛舞。</p>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">豬苗代湖</h3>
                        <p class="text-sm text-gray-500">有「天鏡湖」之稱。</p>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-indigo-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800"><i class="fas fa-bed text-indigo-400 mr-1"></i> 入住: 裏磐梯 Lake Resort</h3>
                    </div>
                </div>
                 <div class="mt-2 bg-slate-50 rounded-lg p-3 text-sm text-gray-600 space-y-2">
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">早</span> <span class="flex-1">飯店內用</span></div>
                    <div class="flex"><span class="w-6 font-bold text-orange-400 text-xs pt-1">午</span> <span class="flex-1 font-medium text-orange-700">日式燒肉吃到飽</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">晚</span> <span class="flex-1">飯店自助餐</span></div>
                </div>
            </div>

             <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                    <div>
                        <h2 class="font-bold text-lg">DAY 3 <span class="text-sm font-normal text-gray-400 ml-2">01/25 (日)</span></h2>
                        <div id="weather-stats-2" class="mt-2 flex flex-wrap gap-y-2">
                             <span class="text-xs text-gray-400 loading-pulse">載入中...</span>
                        </div>
                    </div>
                    <div id="weather-icon-2" class="text-2xl text-gray-300"></div>
                </div>
                <div class="space-y-4 relative pl-4 border-l-2 border-gray-100 pb-2 pt-2">
                    <p class="text-xs text-gray-400 absolute -top-2 left-2 bg-[#F9FAFB] px-1">地點: 山形銀山</p>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-blue-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">High翻天雪樂園</h3>
                        <p class="text-sm text-gray-500">雪上摩托車、香蕉船無限暢玩。</p>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-pink-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">銀山溫泉散策</h3>
                        <p class="text-sm text-gray-500">阿信的故鄉，大正浪漫風情。</p>
                    </div>
                     <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-indigo-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800"><i class="fas fa-bed text-indigo-400 mr-1"></i> 入住: 鳴子溫泉 幸雲閣</h3>
                    </div>
                </div>
                 <div class="mt-2 bg-slate-50 rounded-lg p-3 text-sm text-gray-600 space-y-2">
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">早</span> <span class="flex-1">飯店內用</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">午</span> <span class="flex-1">日式烏龍麵+豬肉鍋定食</span></div>
                    <div class="flex"><span class="w-6 font-bold text-orange-400 text-xs pt-1">晚</span> <span class="flex-1 font-medium text-orange-700">螃蟹吃到飽 (飯店自助餐)</span></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                    <div>
                        <h2 class="font-bold text-lg">DAY 4 <span class="text-sm font-normal text-gray-400 ml-2">01/26 (一)</span></h2>
                        <div id="weather-stats-3" class="mt-2 flex flex-wrap gap-y-2">
                             <span class="text-xs text-gray-400 loading-pulse">載入中...</span>
                        </div>
                    </div>
                    <div id="weather-icon-3" class="text-2xl text-gray-300"></div>
                </div>
                <div class="space-y-4 relative pl-4 border-l-2 border-gray-100 pb-2 pt-2">
                    <p class="text-xs text-gray-400 absolute -top-2 left-2 bg-[#F9FAFB] px-1">地點: 山形藏王</p>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-blue-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">藏王樹冰 (搭乘纜車)</h3>
                        <p class="text-sm text-gray-500">冬季限定「雪怪」奇景。</p>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">大內宿古街</h3>
                        <p class="text-sm text-gray-500">茅草屋建築，日本三大合掌村之一。</p>
                    </div>
                     <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-indigo-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800"><i class="fas fa-bed text-indigo-400 mr-1"></i> 入住: 乃木溫泉飯店</h3>
                    </div>
                </div>
                 <div class="mt-2 bg-slate-50 rounded-lg p-3 text-sm text-gray-600 space-y-2">
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">早</span> <span class="flex-1">飯店內用</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">午</span> <span class="flex-1">拉麵代金 2500日幣</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">晚</span> <span class="flex-1">飯店內會席料理</span></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                    <div>
                        <h2 class="font-bold text-lg">DAY 5 <span class="text-sm font-normal text-gray-400 ml-2">01/27 (二)</span></h2>
                        <div id="weather-stats-4" class="mt-2 flex flex-wrap gap-y-2">
                             <span class="text-xs text-gray-400 loading-pulse">載入中...</span>
                        </div>
                    </div>
                    <div id="weather-icon-4" class="text-2xl text-gray-300"></div>
                </div>
                <div class="space-y-4 relative pl-4 border-l-2 border-gray-100 pb-2 pt-2">
                    <p class="text-xs text-gray-400 absolute -top-2 left-2 bg-[#F9FAFB] px-1">地點: 東京</p>
                     <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-red-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">採草莓吃到飽</h3>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">明治神宮</h3>
                    </div>
                     <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-indigo-400 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800"><i class="fas fa-bed text-indigo-400 mr-1"></i> 入住: APA東京幕張</h3>
                    </div>
                </div>
                 <div class="mt-2 bg-slate-50 rounded-lg p-3 text-sm text-gray-600 space-y-2">
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">早</span> <span class="flex-1">飯店內用</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">午</span> <span class="flex-1">日式風味餐</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">晚</span> <span class="flex-1">自理 (方便逛街)</span></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-3">
                    <div>
                        <h2 class="font-bold text-lg">DAY 6 <span class="text-sm font-normal text-gray-400 ml-2">01/28 (三)</span></h2>
                         <div id="weather-stats-5" class="mt-2 flex flex-wrap gap-y-2">
                             <span class="text-xs text-gray-400 loading-pulse">載入中...</span>
                        </div>
                    </div>
                    <div id="weather-icon-5" class="text-2xl text-gray-300"></div>
                </div>
                 <div class="space-y-4 relative pl-4 border-l-2 border-gray-100 pb-2 pt-2">
                     <p class="text-xs text-gray-400 absolute -top-2 left-2 bg-[#F9FAFB] px-1">地點: 東京</p>
                     <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">雷門 淺草寺</h3>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-yellow-500 rounded-full border-2 border-white"></div>
                        <h3 class="font-bold text-gray-800">上野 阿美橫町</h3>
                    </div>
                    <div class="relative">
                        <div class="absolute -left-[21px] top-1 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div>
                        <p class="text-xs text-gray-400 mb-1">20:20 - 23:25</p>
                        <h3 class="font-bold text-gray-800"><i class="fas fa-plane text-blue-400 mr-1"></i> 返回台北 (BR195)</h3>
                    </div>
                </div>
                 <div class="mt-2 bg-slate-50 rounded-lg p-3 text-sm text-gray-600 space-y-2">
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">早</span> <span class="flex-1">飯店內用</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">午</span> <span class="flex-1">自理 (方便逛街)</span></div>
                    <div class="flex"><span class="w-6 font-bold text-gray-400 text-xs pt-1">晚</span> <span class="flex-1">機上套餐</span></div>
                </div>
            </div>

        </div>

        <div id="view-tools" class="hidden space-y-6">
            
            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-ticket-alt text-blue-400 mr-2"></i>航班資訊</h3>
                <div class="bg-gray-50 rounded-lg p-3 mb-2">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-bold">去程 BR196</span>
                        <span class="text-gray-500">01/23</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-xl font-bold">15:20</div>
                            <div class="text-xs text-gray-400">TPE 桃園 T2</div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-300"></i>
                        <div class="text-right">
                            <div class="text-xl font-bold">19:20</div>
                            <div class="text-xs text-gray-400">NRT 東京</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-bold">回程 BR195</span>
                        <span class="text-gray-500">01/28</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-xl font-bold">20:20</div>
                            <div class="text-xs text-gray-400">NRT 東京 T2</div>
                        </div>
                        <i class="fas fa-arrow-right text-gray-300"></i>
                        <div class="text-right">
                            <div class="text-xl font-bold">23:25</div>
                            <div class="text-xs text-gray-400">TPE 桃園</div>
                        </div>
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-500 bg-yellow-50 p-2 rounded">
                    <i class="fas fa-suitcase mr-1"></i> 託運 23KG (1件) / 手提 7KG (1件)
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-phone-alt text-red-400 mr-2"></i>緊急聯絡</h3>
                <div class="grid grid-cols-1 gap-3">
                    <a href="tel:0931700227" class="flex items-center justify-between p-3 border border-gray-100 rounded-lg active:bg-gray-50">
                        <div>
                            <p class="font-bold text-sm">導遊 林慶富</p>
                            <p class="text-xs text-gray-400">0931-700-227</p>
                        </div>
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-500">
                            <i class="fas fa-phone"></i>
                        </div>
                    </a>
                    <a href="tel:0975289518" class="flex items-center justify-between p-3 border border-gray-100 rounded-lg active:bg-gray-50">
                        <div>
                            <p class="font-bold text-sm">佳時樂旅行社 林芝怡</p>
                            <p class="text-xs text-gray-400">0975-289-518</p>
                        </div>
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-500">
                            <i class="fas fa-phone"></i>
                        </div>
                    </a>
                    <a href="tel:+886800085095" class="flex items-center justify-between p-3 border border-gray-100 rounded-lg active:bg-gray-50 bg-red-50 border-red-100">
                        <div>
                            <p class="font-bold text-sm text-red-600">外交部緊急救助 (全球)</p>
                            <p class="text-xs text-red-400">+886-800-085-095</p>
                        </div>
                        <div class="w-8 h-8 bg-red-200 rounded-full flex items-center justify-center text-red-600">
                            <i class="fas fa-ambulance"></i>
                        </div>
                    </a>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-hotel text-indigo-400 mr-2"></i>住宿資訊</h3>
                <ul class="text-sm space-y-3">
                    <li class="flex justify-between border-b border-gray-50 pb-2">
                        <span>Day 1</span>
                        <span class="font-medium text-right">成田日航飯店<br><span class="text-xs text-gray-400">0476-32-0032</span></span>
                    </li>
                    <li class="flex justify-between border-b border-gray-50 pb-2">
                        <span>Day 2</span>
                        <span class="font-medium text-right">裏磐梯 Lake Resort<br><span class="text-xs text-gray-400">0241-37-1111</span></span>
                    </li>
                    <li class="flex justify-between border-b border-gray-50 pb-2">
                        <span>Day 3</span>
                        <span class="font-medium text-right">鳴子溫泉 幸雲閣<br><span class="text-xs text-gray-400">050-3615-3456</span></span>
                    </li>
                    <li class="flex justify-between border-b border-gray-50 pb-2">
                        <span>Day 4</span>
                        <span class="font-medium text-right">乃木溫泉飯店<br><span class="text-xs text-gray-400">0287-37-4126</span></span>
                    </li>
                     <li class="flex justify-between pb-2">
                        <span>Day 5</span>
                        <span class="font-medium text-right">APA東京幕張<br><span class="text-xs text-gray-400">0570-070-111</span></span>
                    </li>
                </ul>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-coins text-yellow-500 mr-2"></i>即時匯率換算</h3>
                <div class="flex items-center space-x-2 bg-gray-50 p-4 rounded-xl">
                    <div class="flex-1">
                        <label class="text-xs text-gray-400 block mb-1">日幣 (JPY)</label>
                        <input type="number" id="calc-jpy" placeholder="輸入" class="w-full bg-transparent text-xl font-bold text-gray-700 outline-none" oninput="convertCurrency()">
                    </div>
                    <i class="fas fa-arrow-right text-gray-300"></i>
                    <div class="flex-1 text-right">
                        <label class="text-xs text-gray-400 block mb-1">台幣 (TWD)</label>
                        <div id="calc-twd" class="text-xl font-bold text-blue-500">0</div>
                    </div>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-right">匯率參考: 1 JPY ≈ <span id="calc-rate-display">...</span> TWD</p>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800"><i class="fas fa-calculator text-yellow-400 mr-2"></i>購物記帳</h3>
                    <button onclick="resetBudget()" class="text-xs text-red-400 underline">重置</button>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-xl mb-4 text-center">
                    <p class="text-xs text-gray-400">目前花費 (JPY)</p>
                    <p class="text-3xl font-bold text-gray-800" id="total-amount">¥0</p>
                    <p class="text-xs text-gray-400 mt-1">約台幣 NT$ <span id="twd-amount">0</span></p>
                </div>

                <div class="flex gap-1 mb-4">
                    <input type="text" id="item-name" placeholder="品項 (如: 藥妝)" class="flex-[2] min-w-0 bg-gray-100 border-none rounded-lg text-sm px-2 py-2 outline-none">
                    <input type="number" id="item-price" placeholder="¥ 金額" class="w-20 bg-gray-100 border-none rounded-lg text-sm px-2 py-2 outline-none">
                    <button onclick="addItem()" class="bg-blue-500 text-white rounded-lg px-3 py-2"><i class="fas fa-plus"></i></button>
                </div>

                <ul id="budget-list" class="space-y-2 text-sm max-h-40 overflow-y-auto">
                    </ul>
            </div>

        </div>
    </main>

    <script>
        // --- 1. Tab Switching Logic ---
        function switchTab(tabName) {
            const itineraryView = document.getElementById('view-itinerary');
            const toolsView = document.getElementById('view-tools');
            const btnItinerary = document.getElementById('btn-itinerary');
            const btnTools = document.getElementById('btn-tools');

            if (tabName === 'itinerary') {
                itineraryView.classList.remove('hidden');
                toolsView.classList.add('hidden');
                btnItinerary.className = 'flex-1 py-4 text-sm tab-active transition-all';
                btnTools.className = 'flex-1 py-4 text-sm tab-inactive transition-all';
            } else {
                itineraryView.classList.add('hidden');
                toolsView.classList.remove('hidden');
                btnItinerary.className = 'flex-1 py-4 text-sm tab-inactive transition-all';
                btnTools.className = 'flex-1 py-4 text-sm tab-active transition-all';
            }
        }

        // --- 2. Independent Weather Fetch Logic (Robust) ---
        const tripLocations = [
            { day: 0, lat: 35.77, lon: 140.39, name: "Narita" },
            { day: 1, lat: 37.49, lon: 139.93, name: "Aizu" },
            { day: 2, lat: 38.57, lon: 140.40, name: "Ginzan" },
            { day: 3, lat: 38.16, lon: 140.45, name: "Zao" },
            { day: 4, lat: 35.68, lon: 139.76, name: "Tokyo" },
            { day: 5, lat: 35.68, lon: 139.76, name: "Tokyo" }
        ];

        document.addEventListener("DOMContentLoaded", () => {
            // Safety wrapper to ensure one crash doesn't stop others
            try { fetchAllWeather(); } catch(e) { console.error(e); }
            try { fetchHeaderWeather(); } catch(e) { console.error(e); }
            try { fetchExchangeRate(); } catch(e) { console.error(e); }
            try { renderBudget(); } catch(e) { console.error(e); }
        });

        function fetchAllWeather() {
            tripLocations.forEach((loc, index) => {
                fetchDayWeather(loc, index);
            });
        }

        async function fetchDayWeather(loc, index) {
            const statsEl = document.getElementById(`weather-stats-${index}`);
            const iconEl = document.getElementById(`weather-icon-${index}`);
            const timestamp = new Date().getTime(); // Cache busting
            
            // Initial variables
            let weatherData = null;
            let aqiData = null;

            // 1. Fetch Weather (Timeout: 5000ms)
            try {
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,weather_code&daily=precipitation_probability_max,uv_index_max&timezone=Asia%2FTokyo&forecast_days=1&t=${timestamp}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const res = await fetch(weatherUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (res.ok) {
                    weatherData = await res.json();
                }
            } catch (e) {
                console.log(`Weather fetch error Day ${index}:`, e);
            }

            // 2. Fetch AQI (Independent)
            try {
                const aqiUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${loc.lat}&longitude=${loc.lon}&current=us_aqi&t=${timestamp}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const res = await fetch(aqiUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (res.ok) {
                    aqiData = await res.json();
                }
            } catch (e) {
                console.log(`AQI fetch error Day ${index}:`, e);
            }

            renderWeatherUI(statsEl, iconEl, weatherData, aqiData);
        }

        function renderWeatherUI(statsEl, iconEl, wData, aData) {
            let temp = "--";
            let weatherCode = 0;
            let rainProb = "--";
            let uvIndex = "--";
            let weatherHtml = "";

            // Safely parse Weather Data
            if (wData && wData.current) {
                temp = Math.round(wData.current.temperature_2m);
                weatherCode = wData.current.weather_code;
                
                const iconHtml = getWeatherIcon(weatherCode);
                const tempClass = temp < 10 ? 'text-indigo-400' : 'text-orange-400';
                iconEl.innerHTML = `<div class="text-right"><div class="${tempClass}">${iconHtml}</div><div class="text-lg font-bold text-gray-600">${temp}°</div></div>`;
            } else {
                iconEl.innerHTML = `<div class="text-gray-300 text-sm">N/A</div>`;
            }

            if (wData && wData.daily && wData.daily.precipitation_probability_max) {
                rainProb = wData.daily.precipitation_probability_max[0];
            }
            if (wData && wData.daily && wData.daily.uv_index_max) {
                uvIndex = wData.daily.uv_index_max[0];
            }

            // Safely parse AQI Data
            let aqi = "--";
            let aqiColorClass = "text-gray-400";
            if (aData && aData.current) {
                aqi = aData.current.us_aqi;
                if(aqi <= 50) aqiColorClass = "text-green-500";
                else if(aqi <= 100) aqiColorClass = "text-yellow-500";
                else aqiColorClass = "text-red-500";
            }

            // Render text
            if (!wData && !aData) {
                statsEl.innerHTML = `<span class="text-xs text-red-300"><i class="fas fa-exclamation-circle"></i> 連線逾時</span>`;
            } else {
                statsEl.innerHTML = `
                    <span class="weather-tag"><i class="fas fa-umbrella text-blue-400"></i>降雨 ${rainProb}%</span>
                    <span class="weather-tag"><i class="fas fa-sun text-yellow-400"></i>UV ${uvIndex}</span>
                    <span class="weather-tag"><i class="fas fa-wind ${aqiColorClass}"></i>AQI ${aqi}</span>
                `;
            }
        }

        async function fetchHeaderWeather() {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.68&longitude=139.76&current=temperature_2m&timezone=Asia%2FTokyo`);
                if(res.ok) {
                    const data = await res.json();
                    if (data.current) {
                        document.getElementById('header-weather').innerHTML = `${Math.round(data.current.temperature_2m)}<span class="text-sm">°C</span>`;
                    }
                }
            } catch (e) {}
        }

        function getWeatherIcon(code) {
            if (code === 0) return '<i class="fas fa-sun"></i>';
            if (code >= 1 && code <= 3) return '<i class="fas fa-cloud-sun"></i>';
            if (code >= 45 && code <= 48) return '<i class="fas fa-smog"></i>';
            if (code >= 51 && code <= 67) return '<i class="fas fa-cloud-rain"></i>';
            if (code >= 71 && code <= 86) return '<i class="fas fa-snowflake"></i>';
            if (code >= 95) return '<i class="fas fa-bolt"></i>';
            return '<i class="fas fa-cloud"></i>';
        }

        // --- 3. Budget & Converter Logic (Protected) ---
        let items = [];
        let currentRate = 0.22; // Default

        // Safe LocalStorage Access
        try {
            const saved = localStorage.getItem('trip_budget');
            if (saved) items = JSON.parse(saved);
        } catch (e) {
            console.log('LocalStorage not available (Private Mode?)');
        }

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                if(res.ok) {
                    const data = await res.json();
                    if(data && data.rates && data.rates.TWD) {
                        currentRate = data.rates.TWD;
                        // Update Rate Displays
                        const calcRateEl = document.getElementById('calc-rate-display');
                        if(calcRateEl) calcRateEl.innerText = currentRate.toFixed(3);
                        renderBudget();
                        convertCurrency(); // Update calculator if value exists
                    }
                }
            } catch(e) {
                console.log("Rate fetch failed, using default");
            }
        }

        // Currency Converter Function
        function convertCurrency() {
            const jpyInput = document.getElementById('calc-jpy');
            const twdOutput = document.getElementById('calc-twd');
            
            if(jpyInput && twdOutput) {
                const jpy = parseFloat(jpyInput.value);
                if (!isNaN(jpy)) {
                    twdOutput.innerText = Math.round(jpy * currentRate).toLocaleString();
                } else {
                    twdOutput.innerText = "0";
                }
            }
        }

        function renderBudget() {
            const list = document.getElementById('budget-list');
            const totalEl = document.getElementById('total-amount');
            const twdEl = document.getElementById('twd-amount');
            
            if(!list || !totalEl || !twdEl) return;

            list.innerHTML = '';
            let total = 0;

            items.forEach((item, index) => {
                total += item.price;
                list.innerHTML += `
                    <li class="flex justify-between items-center border-b border-gray-50 pb-1">
                        <span class="text-gray-600">${item.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="font-medium">¥${item.price}</span>
                            <button onclick="deleteItem(${index})" class="text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button>
                        </div>
                    </li>
                `;
            });

            totalEl.innerText = '¥' + total.toLocaleString();
            twdEl.innerText = Math.round(total * currentRate).toLocaleString();
            
            try {
                localStorage.setItem('trip_budget', JSON.stringify(items));
            } catch(e) {}
        }

        function addItem() {
            const nameInput = document.getElementById('item-name');
            const priceInput = document.getElementById('item-price');
            
            const name = nameInput.value;
            const price = parseInt(priceInput.value);

            if (name && price) {
                items.push({ name, price });
                nameInput.value = '';
                priceInput.value = '';
                renderBudget();
            }
        }

        function deleteItem(index) {
            items.splice(index, 1);
            renderBudget();
        }

        function resetBudget() {
            if(confirm('確定要清空記帳紀錄嗎？')) {
                items = [];
                renderBudget();
            }
        }
    </script>
</body>
</html>